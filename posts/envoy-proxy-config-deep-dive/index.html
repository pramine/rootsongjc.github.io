<!DOCTYPE html>
<html lang="zh">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title> Istio 的数据平面 Envoy Proxy 配置详解 - 宋净超的博客|Cloud Native|云原生布道师</title>
  <meta name="description" content="宋净超的博客|Cloud Native|云原生布道师" />
  <meta property="og:title" content="Istio 的数据平面 Envoy Proxy 配置详解" />
  <meta name="twitter:title" content="Istio 的数据平面 Envoy Proxy 配置详解" />
  <meta name="description" content="本文介绍了 Envoy proxy 的概念，对应的 xDS 的版本以及配置的详细解析。">
  <meta property="og:description" content="本文介绍了 Envoy proxy 的概念，对应的 xDS 的版本以及配置的详细解析。">
  <meta name="twitter:description" content="本文介绍了 Envoy proxy 的概念，对应的 xDS 的版本以及配置的详细解析。">
  <meta name="author" content="Jimmy Song(宋净超)"/>
  <link href='https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://jimmysong.io/img/jimmysong.jpg" />
  <meta name="twitter:image" content="https://jimmysong.io/img/jimmysong.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@jimmysongio" />
  <meta name="twitter:creator" content="@jimmysongio" />
  <meta property="og:url" content="https://jimmysong.io/posts/envoy-proxy-config-deep-dive/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Jimmy Song" />

  <meta name="generator" content="Hugo 0.55.5" />
  <link rel="canonical" href="https://jimmysong.io/posts/envoy-proxy-config-deep-dive/" />
  <link rel="alternate" href="https://jimmysong.io/index.xml" type="application/rss+xml" title="Jimmy Song">
  <script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/jquery-1.12.4.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="https://jimmysong.io/css/main.css" />
  <link rel="stylesheet" href="https://jimmysong.io/css/search.css" />
  
  <link rel="stylesheet" href="https://jimmysong.io/css/reward.css" />
  
  
  
  <link rel="stylesheet" href="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/baguetteBox.css" />
  
  

<meta name="baidu-site-verification" content="g8IYR9SNLF" />


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?11f7d254cfa4e0ca44b175c66d379ecc";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


<link rel="stylesheet" href="https://jimmysong.io/css/prism.css" />





<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TRBZ6RN');</script>


<meta name="referrer" content="never">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-93485976-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">切换导航</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://jimmysong.io/">Jimmy Song</a>
    </div>
    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">文章分类</a>
              <div class="navlinks-children">
                
                
                  <a href="https://jimmysong.io/categories/kubernetes">kubernetes</a>
                
                
                  <a href="https://jimmysong.io/categories/istio">Istio</a>
                
                
                  <a href="https://jimmysong.io/categories/cloud-native">Cloud Native</a>
                
                
                  <a href="https://jimmysong.io/categories/open-source">Open Source</a>
                
                
                  <a href="https://jimmysong.io/categories/service-mesh">Service Mesh</a>
                
                
                  <a href="https://jimmysong.io/categories/devops">Devops</a>
                
                
                  <a href="https://jimmysong.io/categories/serverless">Serverless</a>
                
                
                  <a href="https://jimmysong.io/tags">Tags</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">电子书</a>
              <div class="navlinks-children">
                
                
                  <a href="https://jimmysong.io/istio-handbook">Istio handbook</a>
                
                
                  <a href="https://jimmysong.io/kubernetes-handbook">Kubernetes handbook</a>
                
                
                  <a href="https://jimmysong.io/docker-handbook">Docker handbook</a>
                
                
                  <a href="https://jimmysong.io/hugo-handbook">Hugo Handbook</a>
                
                
                  <a href="https://jimmysong.io/migrating-to-cloud-native-application-architectures">迁移到云原生应用架构</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">出版物</a>
              <div class="navlinks-children">
                
                
                  <a href="https://jimmysong.io/posts/future-architecture-from-soa-to-cloud-native">未来架构 - 从服务化到云原生</a>
                
                
                  <a href="https://jimmysong.io/posts/cloud-native-go">Cloud Native Go</a>
                
                
                  <a href="https://jimmysong.io/posts/cloud-native-python">Cloud Native Python</a>
                
                
                  <a href="https://jimmysong.io/posts/cloud-native-java">Cloud Native Java</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">活动</a>
              <div class="navlinks-children">
                
                
                  <a href="https://jimmysong.io/sofastack-cloud-native-workshop">SOFAStack Cloud Native Workshop</a>
                
                
                  <a href="https://jimmysong.io/jobs">招聘</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="关于" href="/about">关于</a>
              
              
            </li>
          
        

        
          
            <li>
              
                
              
                
                  <a href="/en" lang="en">English</a>
                
              
            </li>
          
        

        
        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span class="hidden-sm hidden-md hidden-lg">搜索</span> <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
          
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Jimmy Song" href="https://jimmysong.io/">
            <img class="avatar-img" src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/avatar-icon.png" alt="Jimmy Song" />
          </a>
        
      </div>
    </div>

  </div>
</nav>





  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Search jimmysong.io</h4>
        </div>
        <div class="modal-body">
            
<div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..." name="search" autocomplete="off" autofocus="autofocus"/>
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>



<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/algoliasearch.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/autocomplete.min.js"></script>

<script>
var client = algoliasearch("X4YB3WOBNV", "d2134c5a8d250e6d3246594240c45201");
var index = client.initIndex('rootsongjc-hugo');

autocomplete('#aa-search-input',
{ hint: false}, {
    source: autocomplete.sources.hits(index, {hitsPerPage: 5}),
    
    displayKey: 'name',
    
    templates: {
        
        suggestion: function(suggestion) {
            
            return '<span>' + '<a href="/' + suggestion.uri+ '">' +
            suggestion._highlightResult.title.value + '</a></span>';
        }
    }
});
</script>


        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
        </div>
      </div>
    </div>
  </div>


    
  
  
  




  
    <div id="header-big-imgs" data-num-img=1 data-img-src-1="https://jimmysong.io/img/banners/006tNc79ly1fyy3et9btqj31d80nane1.jpg" data-img-desc-1="Photo via unsplash"></div>
  

  <header class="header-section has-img">
    
      <div class="intro-header big-img">
        
        <div class="container">
          <div class="row">
              <div class="col-lg-12 col-md-12 col-md-offset-0">
                
                <div class="post-heading">
                
                  
                     <h1>Istio 的数据平面 Envoy Proxy 配置详解</h1>
                     
                     
                  
                  
                  
                    
                      <hr class="small">
                      <span class="post-subheading">你该了解的那些 Envoy 配置</span>
                    
                  
                  
                    <span class="post-meta">
  
  发表于 2019年1月7日
  
  
</span>


                  
                
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;"></span>
      </div>
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-12 col-md-12 col-md-offset-0">
            <div class="posts-heading">
                <h1 align="center">Istio 的数据平面 Envoy Proxy 配置详解</h1>
                
                  
                    <h2 align="center" class="posts-subheading">你该了解的那些 Envoy 配置</h2>
                  
                
                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main" itemscope itemtype="http://schema.org/Article">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            
            
            
<div>
    <h5 id="wc">5200 字 | 阅读需要 11 分钟</h5>
    <h5 id="tags">标签: 
        
        <a href="https://jimmysong.io/tags/envoy/">envoy</a>&nbsp;
        
        
        
        <a href="https://jimmysong.io/tags/xds/">xds</a>&nbsp;
        
        
    </h5>
</div>

            
            
            
            <article role="main" class="blog-post" itemprop="articleBody" id="content">
                
                

<p>Envoy 是 Istio Service Mesh 中默认的 Sidecar，Istio 在 Enovy 的基础上按照 Envoy 的 xDS 协议扩展了其控制平面，在讲到 Envoy xDS 协议之前还需要我们先熟悉下 Envoy 的基本术语。下面列举了 Envoy 里的基本术语及其数据结构解析，关于 Envoy 的详细介绍请参考 <a href="http://www.servicemesher.com/envoy/">Envoy 官方文档</a>，至于 Envoy 在 Service Mesh（不仅限于 Istio） 中是如何作为转发代理工作的请参考网易云刘超的这篇<a href="https://www.cnblogs.com/163yun/p/8962278.html">深入解读 Service Mesh 背后的技术细节 </a>以及<a href="https://jimmysong.io/posts/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/">理解 Istio Service Mesh 中 Envoy 代理 Sidecar 注入及流量劫持</a>，本文引用其中的一些观点，详细内容不再赘述。</p>

<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fy9qkff5nij314k0ts43z.jpg" alt="Envoy proxy 架构图" /></p>

<h3 id="基本术语">基本术语</h3>

<p>下面是您应该了解的 Enovy 里的基本术语：</p>

<ul>
<li><strong>Downstream（下游）</strong>：下游主机连接到 Envoy，发送请求并接收响应，即发送请求的主机。</li>

<li><p><strong>Upstream（上游）</strong>：上游主机接收来自 Envoy 的连接和请求，并返回响应，即接受请求的主机。</p></li>

<li><p><strong>Listener（监听器）</strong>：监听器是命名网地址（例如，端口、unix domain socket 等)，下游客户端可以连接这些监听器。Envoy 暴露一个或者多个监听器给下游主机连接。</p></li>

<li><p><strong>Cluster（集群）</strong>：集群是指 Envoy 连接的一组逻辑相同的上游主机。Envoy 通过<a href="http://www.servicemesher.com/envoy/intro/arch_overview/service_discovery.html#arch-overview-service-discovery">服务发现</a>来发现集群的成员。可以选择通过<a href="http://www.servicemesher.com/envoy/intro/arch_overview/health_checking.html#arch-overview-health-checking">主动健康检查</a>来确定集群成员的健康状态。Envoy 通过<a href="http://www.servicemesher.com/envoy/intro/arch_overview/load_balancing.html#arch-overview-load-balancing">负载均衡策略</a>决定将请求路由到集群的哪个成员。</p></li>
</ul>

<p>我将在本文的后半部分解释以上术语与 Kubernetes、Istio 中概念之间的联系。</p>

<h2 id="关于-xds-的版本">关于 xDS 的版本</h2>

<p>有一点需要大家注意，就是 Envoy 的 API 有 v1 和 v2 两个版本，从 Envoy 1.5.0 起 v2 API 就已经生产就绪了，为了能够让用户顺利的向 v2 版本的额 API 过度，Envoy 启动的时候设置了一个 <code>--v2-config-only</code> 的标志，Enovy 不同版本对 v1/v2 API 的支持详情请参考 <a href="https://groups.google.com/forum/#!topic/envoy-announce/Lb1QZcSclGQ">Envoy v1 配置废弃时间表</a>。</p>

<p>Envoy 的作者 Matt Klein 在 <a href="http://www.servicemesher.com/blog/the-universal-data-plane-api/">Service Mesh 中的通用数据平面 API 设计</a>这篇文章中说明了 Envoy API v1 的历史及其缺点，还有 v2 的引入。v2 API 是 v1 的演进，而不是革命，它是 v1 功能的超集。</p>

<p>在 Istio 1.0 及以上版本中使用的是 <strong>Envoy 1.8.0-dev</strong> 版本，其支持 v2 的 API，同时在 Envoy 作为 Sidecar proxy 启动的使用使用了例如下面的命令：</p>

<pre><code class="language-bash">$ /usr/local/bin/envoy -c /etc/istio/proxy/envoy-rev0.json --restart-epoch 0 --drain-time-s 45 --parent-shutdown-time-s 60 --service-cluster ratings --service-node sidecar~172.33.14.2~ratings-v1-8558d4458d-ld8x9.default~default.svc.cluster.local --max-obj-name-len 189 --allow-unknown-fields -l warn --v2-config-only
</code></pre>

<p>上面是都 Bookinfo 示例中的 rating pod 中的 sidecar 启动的分析，可以看到其中指定了 <code>--v2-config-only</code>，表明 Istio 1.0+ 只支持 xDS v2 的 API。</p>

<h2 id="istio-sidecar-proxy-配置">Istio sidecar proxy 配置</h2>

<p>假如您使用 <a href="https://github.com/rootsongjc/kubernetes-vagrant-centos-cluster">kubernetes-vagrant-centos-cluster</a> 部署了 Kubernetes 集群并开启了 <a href="https://istio.io/zh">Istio Service Mesh</a>，再部署 <a href="https://istio.io/zh/docs/examples/bookinfo/">bookinfo 示例</a>，那么在 <code>default</code> 命名空间下有一个名字类似于 <code>ratings-v1-7c9949d479-dwkr4</code> 的 Pod，使用下面的命令查看该 Pod 的 Envoy sidecar 的全量配置：</p>

<pre><code class="language-bash">kubectl -n default exec ratings-v1-7c9949d479-dwkr4 -c istio-proxy curl http://localhost:15000/config_dump &gt; dump-rating.json
</code></pre>

<p>将 Envoy 的运行时配置 dump 出来之后你将看到一个长 6000 余行的配置文件。关于该配置文件的介绍请参考 <a href="http://www.servicemesher.com/envoy/configuration/overview/v2_overview.html">Envoy v2 API 概览</a>。</p>

<p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fyb74brsd5j30xg0lojvt.jpg" alt="Envoy 配置" /></p>

<p>Istio 会在为 Service Mesh 中的每个 Pod 注入 Sidecar 的时候同时为 Envoy 注入 Bootstrap 配置，其余的配置是通过 Pilot 下发的，注意整个数据平面即 Service Mesh 中的 Envoy 的动态配置应该是相同的。您也可以使用上面的命令检查其他 sidecar 的 Envoy 配置是否跟最上面的那个相同。</p>

<p>使用下面的命令检查 Service Mesh 中的所有有 Sidecar 注入的 Pod 中的 proxy 配置是否同步。</p>

<pre><code class="language-bash">$ istioctl proxy-status
PROXY                                                 CDS        LDS        EDS               RDS          PILOT                            VERSION
details-v1-876bf485f-sx7df.default                    SYNCED     SYNCED     SYNCED (100%)     SYNCED       istio-pilot-5bf6d97f79-6lz4x     1.0.0
...
</code></pre>

<p><a href="https://istio.io/zh/docs/reference/commands/istioctl/">istioctl</a> 这个命令行工具就像 <a href="https://jimmysong.io/kubernetes-handbook/guide/kubectl-cheatsheet.html">kubectl</a> 一样有很多神器的魔法，通过它可以高效的管理 Istio 和 debug。</p>

<h2 id="envoy-proxy-配置解析">Envoy proxy 配置解析</h2>

<p>Istio envoy sidecar proxy 配置中包含以下四个部分。</p>

<ul>
<li><strong>bootstrap</strong>：Envoy proxy 启动时候加载的静态配置。</li>
<li><strong>listeners</strong>：监听器配置，使用 LDS 下发。</li>
<li><strong>clusters</strong>：集群配置，静态配置中包括 xds-grpc 和 zipkin 地址，动态配置使用  CDS 下发。</li>
<li><strong>routes</strong>：路由配置，静态配置中包括了本地监听的服务的集群信息，其中引用了 cluster，动态配置使用 RDS 下发。</li>
</ul>

<p>每个部分中都包含静态配置与动态配置，其中 bootstrap 配置又是在集群启动的时候通过 sidecar 启动参数注入的，配置文件在 <code>/etc/istio/proxy/envoy-rev0.json</code>。</p>

<p>Enovy 的配置 dump 出来后的结构如下图所示。</p>

<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fy2x2zk1hhj30ee0h9jtg.jpg" alt="Envoy 配置" /></p>

<p>由于 bootstrap 中的配置是来自 Envoy 启动时加载的静态文件，主要配置了节点信息、tracing、admin 和统计信息收集等信息，这不是本文的重点，大家可以自行研究。</p>

<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fy2xid761zj30c70ai0tj.jpg" alt="bootstrap 配置" /></p>

<p>上图是 bootstrap 的配置信息。</p>

<p><a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/bootstrap/v2/bootstrap.proto.html#envoy-api-msg-config-bootstrap-v2-bootstrap">Bootstrap</a> 是 Envoy 中配置的根本来源，<a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/bootstrap/v2/bootstrap.proto.html#envoy-api-msg-config-bootstrap-v2-bootstrap">Bootstrap</a> 消息中有一个关键的概念，就是静态和动态资源的之间的区别。例如 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/lds.proto.html#envoy-api-msg-listener">Listener</a> 或 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/cds.proto.html#envoy-api-msg-cluster">Cluster</a> 这些资源既可以从 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/bootstrap/v2/bootstrap.proto.html#envoy-api-field-config-bootstrap-v2-bootstrap-static-resources">static_resources</a> 静态的获得也可以从 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/bootstrap/v2/bootstrap.proto.html#envoy-api-field-config-bootstrap-v2-bootstrap-dynamic-resources">dynamic_resources</a> 中配置的 <a href="http://www.servicemesher.com/envoy/configuration/listeners/lds.html#config-listeners-lds">LDS</a> 或 <a href="http://www.servicemesher.com/envoy/configuration/cluster_manager/cds.html#config-cluster-manager-cds">CDS</a> 之类的 xDS 服务获取。</p>

<h3 id="listener">Listener</h3>

<p>Listener 顾名思义，就是监听器，监听 IP 地址和端口，然后根据策略转发。</p>

<p><strong>Listener 的特点</strong></p>

<ul>
<li>每个 Envoy 进程中可以有多个 Listener，Envoy 与 Listener 之间是一对多的关系。</li>
<li>每个 Listener 中可以配置一条 filter 链表（filter_chains），Envoy 会根据 filter 顺序执行过滤。</li>
<li>Listener 可以监听下游的端口，也可以接收来自其他 listener 的数据，形成链式处理。</li>
<li>filter 是可扩展的。</li>
<li>可以静态配置，也可以使用 LDS 动态配置。</li>
<li>目前只能监听 TCP，UDP 还未支持。</li>
</ul>

<p><strong>Listener 的数据结构</strong></p>

<p>Listener 的数据结构如下，除了 <code>name</code>、<code>address</code> 和 <code>filter_chains</code> 为必须配置之外，其他都为可选的。</p>

<pre><code class="language-json">{
  &quot;name&quot;: &quot;...&quot;,
  &quot;address&quot;: &quot;{...}&quot;,
  &quot;filter_chains&quot;: [],
  &quot;use_original_dst&quot;: &quot;{...}&quot;,
  &quot;per_connection_buffer_limit_bytes&quot;: &quot;{...}&quot;,
  &quot;metadata&quot;: &quot;{...}&quot;,
  &quot;drain_type&quot;: &quot;...&quot;,
  &quot;listener_filters&quot;: [],
  &quot;transparent&quot;: &quot;{...}&quot;,
  &quot;freebind&quot;: &quot;{...}&quot;,
  &quot;socket_options&quot;: [],
  &quot;tcp_fast_open_queue_length&quot;: &quot;{...}&quot;,
  &quot;bugfix_reverse_write_filter_order&quot;: &quot;{...}&quot;
}
</code></pre>

<p>下面是关于上述数据结构中的常用配置解析。</p>

<ul>
<li><p><strong>name</strong>：该 listener 的 UUID，唯一限定名，默认60个字符，例如 <code>10.254.74.159_15011</code>，可以使用命令参数指定长度限制。</p></li>

<li><p><strong>address</strong>：监听的逻辑/物理地址和端口号，例如</p></li>
</ul>

<pre><code class="language-json">  &quot;address&quot;: {
         &quot;socket_address&quot;: {
          &quot;address&quot;: &quot;10.254.74.159&quot;,
          &quot;port_value&quot;: 15011
         }
  }
</code></pre>

<ul>
<li><p><strong>filter_chains</strong>：这是一个列表，Envoy 中内置了一些通用的 filter，每种 filter 都有特定的数据结构，Enovy 会根据该配置顺序执行 filter。Envoy 中内置的 filter 有：<a href="https://www.envoyproxy.io/docs/envoy/v1.8.0/configuration/network_filters/client_ssl_auth_filter#config-network-filters-client-ssl-auth">envoy.client_ssl_auth</a>、<a href="https://www.envoyproxy.io/docs/envoy/v1.8.0/configuration/network_filters/echo_filter#config-network-filters-echo">envoy.echo</a>、<a href="https://www.envoyproxy.io/docs/envoy/v1.8.0/configuration/http_conn_man/http_conn_man#config-http-conn-man">enovy.http_connection_manager</a>、<a href="https://www.envoyproxy.io/docs/envoy/v1.8.0/configuration/network_filters/mongo_proxy_filter#config-network-filters-mongo-proxy">envoy.mongo_proxy</a>、<a href="https://www.envoyproxy.io/docs/envoy/v1.8.0/configuration/network_filters/rate_limit_filter#config-network-filters-rate-limit">envoy.rate_limit</a>、<a href="https://www.envoyproxy.io/docs/envoy/v1.8.0/configuration/network_filters/redis_proxy_filter#config-network-filters-redis-proxy">enovy.redis_proxy</a>、<a href="https://www.envoyproxy.io/docs/envoy/v1.8.0/configuration/network_filters/tcp_proxy_filter#config-network-filters-tcp-proxy">envoy.tcp_proxy</a>、<a href="https://www.envoyproxy.io/docs/envoy/v1.8.0/intro/arch_overview/http_filters">http_filters</a>、<a href="https://www.envoyproxy.io/docs/envoy/v1.8.0/configuration/thrift_filters/thrift_filters">thrift_filters</a>等。这些 filter 可以单独使用也可以组合使用，还可以自定义扩展，例如使用 Istio 中的 <a href="https://istio.io/zh/docs/reference/config/istio.networking.v1alpha3/#envoyfilter">EnvoyFilter 配置</a>。</p></li>

<li><p><strong>use_original_dst</strong>：这是一个布尔值，如果使用 iptables 重定向连接，则代理接收的端口可能与<a href="http://www.servicemesher.com/envoy/configuration/listener_filters/original_dst_filter.html">原始目的地址</a>的端口不一样。当此标志设置为 true 时，Listener 将重定向的连接切换到与原始目的地址关联的 Listener。如果没有与原始目的地址关联的 Listener，则连接由接收它的 Listener 处理。默认为 false。注意：该参数将被废弃，请使用<a href="http://www.servicemesher.com/envoy/configuration/listener_filters/original_dst_filter.html">原始目的地址</a>的 Listener filter 替代。该参数的主要用途是：Envoy 通过监听 15001 端口将应用的流量截取后再由其他 Listener 处理而不是直接转发出去，详情见 <a href="https://zhaohuabing.com/post/2018-09-25-istio-traffic-management-impl-intro/#virtual-listener">Virtual Listener</a>。</p></li>
</ul>

<p>关于 Listener 的详细介绍请参考 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/lds.proto#envoy-api-msg-listener">Envoy v2 API reference - listener</a>。</p>

<h3 id="route">Route</h3>

<p>我们在这里所说的路由指的是 <a href="http://www.servicemesher.com/envoy/intro/arch_overview/http_routing.html">HTTP 路由</a>，这也使得 Envoy 可以用来处理网格边缘的流量。HTTP 路由转发是通过路由过滤器实现的。该过滤器的主要职能就是执行<a href="https://www.envoyproxy.io/docs/envoy/latest/api-v1/route_config/route_config#config-http-conn-man-route-table">路由表</a>中的指令。除了可以做重定向和转发，路由过滤器还需要处理重试、统计之类的任务。</p>

<p><strong>HTTP 路由的特点</strong></p>

<ul>
<li>前缀和精确路径匹配规则。</li>
<li>可跨越多个上游集群进行基于<a href="https://www.envoyproxy.io/docs/envoy/latest/api-v1/route_config/route#config-http-conn-man-route-table-route-weighted-clusters">权重/百分比的路由</a>。</li>
<li>基于<a href="http://www.servicemesher.com/envoy/intro/arch_overview/http_routing.html#arch-overview-http-routing-priority">优先级</a>的路由。</li>
<li>基于<a href="https://www.envoyproxy.io/docs/envoy/latest/api-v1/route_config/route#config-http-conn-man-route-table-hash-policy">哈希</a>策略的路由。</li>
</ul>

<p><strong>Route 的数据结构</strong></p>

<pre><code class="language-json">{
  &quot;name&quot;: &quot;...&quot;,
  &quot;virtual_hosts&quot;: [],
  &quot;internal_only_headers&quot;: [],
  &quot;response_headers_to_add&quot;: [],
  &quot;response_headers_to_remove&quot;: [],
  &quot;request_headers_to_add&quot;: [],
  &quot;request_headers_to_remove&quot;: [],
  &quot;validate_clusters&quot;: &quot;{...}&quot;
}
</code></pre>

<p>下面是关于上述数据结构中的常用配置解析。</p>

<ul>
<li><strong>name</strong>：该名字跟 <code>envoy.http_connection_manager</code> filter 中的 <code>http_filters.rds.route_config_name</code> 一致，在 Istio Service Mesh 中为 Envoy 下发的配置中的 Route 是以监听的端口号作为名字，而同一个名字下面的 <code>virtual_hosts</code> 可以有多个值（数组形式）。</li>
<li><strong>virtual_hosts</strong>：因为 <strong>VirtualHosts</strong> 是 Envoy 中引入的一个重要概念，我们在下文将详细说明 <code>virtual_hosts</code> 的数据结构。</li>
<li><strong>validate_clusters</strong>：这是一个布尔值，用来设置开启使用 cluster manager 来检测路由表引用的 cluster 是否有效。如果是路由表是通过 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/filter/network/http_connection_manager/v2/http_connection_manager.proto#envoy-api-field-config-filter-network-http-connection-manager-v2-httpconnectionmanager-route-config">route_config</a> 静态配置的则该值默认设置为 true，如果是使用 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/filter/network/http_connection_manager/v2/http_connection_manager.proto#envoy-api-field-config-filter-network-http-connection-manager-v2-httpconnectionmanager-rds">rds</a> 动态配置的话，则该值默认设置为 false。</li>
</ul>

<p>关于 Route 的详细介绍请参考 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/rds.proto">Envoy v2 API reference - HTTP route configuration</a>。</p>

<h4 id="route-virtualhost">route.VirtualHost</h4>

<p>VirtualHost 即上文中 Route 配置中的 <code>virtual_hosts</code>，VirtualHost 是路由配置中的顶级元素。每个虚拟主机都有一个逻辑名称以及一组根据传入请求的 host header 路由到它的域。这允许单个 Listener 为多个顶级域路径树提供服务。基于域选择了虚拟主机后 Envoy  就会处理路由以查看要路由到哪个上游集群或是否执行重定向。</p>

<p><strong>VirtualHost 的数据结构</strong></p>

<p>下面是 VirtualHost 的数据结构，除了 <code>name</code> 和 <code>domains</code> 是必须配置项外，其他皆为可选项。</p>

<pre><code class="language-json">{
  &quot;name&quot;: &quot;...&quot;,
  &quot;domains&quot;: [],
  &quot;routes&quot;: [],
  &quot;require_tls&quot;: &quot;...&quot;,
  &quot;virtual_clusters&quot;: [],
  &quot;rate_limits&quot;: [],
  &quot;request_headers_to_add&quot;: [],
  &quot;request_headers_to_remove&quot;: [],
  &quot;response_headers_to_add&quot;: [],
  &quot;response_headers_to_remove&quot;: [],
  &quot;cors&quot;: &quot;{...}&quot;,
  &quot;per_filter_config&quot;: &quot;{...}&quot;,
  &quot;include_request_attempt_count&quot;: &quot;...&quot;
}
</code></pre>

<p>下面是关于上述数据结构中的常用配置解析。</p>

<ul>
<li><strong>name</strong>：该 VirtualHost 的名字，一般是 FQDN 加端口，如 <code>details.default.svc.cluster.local:9080</code>。</li>
<li><strong>domains</strong>：这是个用来匹配 VirtualHost 的域名（host/authority header）列表，也可以使用通配符，但是通配符不能匹配空字符，除了仅使用 <code>*</code> 作为 domains，注意列表中的值不能重复和存在交集，只要有一条 domain 被匹配上了，就会执行路由。Istio 会为该值配置所有地址解析形式，包括 IP 地址、FQDN 和短域名等。</li>
<li><strong>routes</strong>：针对入口流量的有序路由列表，第一个匹配上的路由将被执行。我们在下文将详细说明 route 的数据结构。</li>
</ul>

<p>下面是一个实际的 VirtualHost 的例子，该配置来自 <a href="https://istio.io/zh/docs/examples/bookinfo/">Bookinfo 应用</a>的 details 应用的 Sidecar 服务。</p>

<pre><code class="language-json">{
            &quot;name&quot;: &quot;details.default.svc.cluster.local:9080&quot;,
            &quot;domains&quot;: [
                &quot;details.default.svc.cluster.local&quot;,
                &quot;details.default.svc.cluster.local:9080&quot;,
                &quot;details&quot;,
                &quot;details:9080&quot;,
                &quot;details.default.svc.cluster&quot;,
                &quot;details.default.svc.cluster:9080&quot;,
                &quot;details.default.svc&quot;,
                &quot;details.default.svc:9080&quot;,
                &quot;details.default&quot;,
                &quot;details.default:9080&quot;,
                &quot;10.254.4.113&quot;,
                &quot;10.254.4.113:9080&quot;
            ],
            &quot;routes&quot;: [
                {
                    &quot;match&quot;: {
                        &quot;prefix&quot;: &quot;/&quot;
                    },
                    &quot;route&quot;: {
                        &quot;cluster&quot;: &quot;outbound|9080||details.default.svc.cluster.local&quot;,
                        &quot;timeout&quot;: &quot;0s&quot;,
                        &quot;max_grpc_timeout&quot;: &quot;0s&quot;
                    },
                    &quot;decorator&quot;: {
                        &quot;operation&quot;: &quot;details.default.svc.cluster.local:9080/*&quot;
                    },
                    &quot;per_filter_config&quot;: {
                        &quot;mixer&quot;: {
                            &quot;forward_attributes&quot;: {
                                &quot;attributes&quot;: {
                                    &quot;destination.service.uid&quot;: {
                                        &quot;string_value&quot;: &quot;istio://default/services/details&quot;
                                    },
                                    &quot;destination.service.host&quot;: {
                                        &quot;string_value&quot;: &quot;details.default.svc.cluster.local&quot;
                                    },
                                    &quot;destination.service.namespace&quot;: {
                                        &quot;string_value&quot;: &quot;default&quot;
                                    },
                                    &quot;destination.service.name&quot;: {
                                        &quot;string_value&quot;: &quot;details&quot;
                                    },
                                    &quot;destination.service&quot;: {
                                        &quot;string_value&quot;: &quot;details.default.svc.cluster.local&quot;
                                    }
                                }
                            },
                            &quot;mixer_attributes&quot;: {
                                &quot;attributes&quot;: {
                                    &quot;destination.service.host&quot;: {
                                        &quot;string_value&quot;: &quot;details.default.svc.cluster.local&quot;
                                    },
                                    &quot;destination.service.uid&quot;: {
                                        &quot;string_value&quot;: &quot;istio://default/services/details&quot;
                                    },
                                    &quot;destination.service.name&quot;: {
                                        &quot;string_value&quot;: &quot;details&quot;
                                    },
                                    &quot;destination.service.namespace&quot;: {
                                        &quot;string_value&quot;: &quot;default&quot;
                                    },
                                    &quot;destination.service&quot;: {
                                        &quot;string_value&quot;: &quot;details.default.svc.cluster.local&quot;
                                    }
                                }
                            },
                            &quot;disable_check_calls&quot;: true
                        }
                    }
                }
            ]
        }
</code></pre>

<p>关于 route.VirtualHost 的详细介绍请参考 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route/route.proto#envoy-api-msg-route-virtualhost">Envoy v2 API reference - route.VirtualHost</a>。</p>

<h4 id="route-route">route.Route</h4>

<p>路由既是如何匹配请求的规范，也是对下一步做什么的指示（例如，redirect、forward、rewrite等）。</p>

<p><strong>route.Route 的数据结构</strong></p>

<p>下面是是 route.Route 的数据结构，除了 <code>match</code> 之外其余都是可选的。</p>

<pre><code class="language-json">{
  &quot;match&quot;: &quot;{...}&quot;,
  &quot;route&quot;: &quot;{...}&quot;,
  &quot;redirect&quot;: &quot;{...}&quot;,
  &quot;direct_response&quot;: &quot;{...}&quot;,
  &quot;metadata&quot;: &quot;{...}&quot;,
  &quot;decorator&quot;: &quot;{...}&quot;,
  &quot;per_filter_config&quot;: &quot;{...}&quot;,
  &quot;request_headers_to_add&quot;: [],
  &quot;request_headers_to_remove&quot;: [],
  &quot;response_headers_to_add&quot;: [],
  &quot;response_headers_to_remove&quot;: []
}
</code></pre>

<p>下面是关于上述数据结构中的常用配置解析。</p>

<ul>
<li><strong>match</strong>：路由匹配参数。例如 URL prefix（前缀）、path（URL 的完整路径）、regex（规则表达式）等。</li>
<li><strong>route</strong>：这里面配置路由的行为，可以是 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route/route.proto#envoy-api-field-route-route-route">route</a>、<a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route/route.proto#envoy-api-field-route-route-redirect">redirect</a> 和 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route/route.proto#envoy-api-field-route-route-direct-response">direct_response</a>，不过这里面没有专门的一个配置项用来配置以上三种行为，而是根据实际填充的配置项来确定的。例如在此处添加 <code>cluster</code> 配置则暗示路由动作为”route“，表示将流量路由到该 cluster。详情请参考 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route/route.proto#route-routeaction">route.RouteAction</a>。</li>
<li><strong>decorator</strong>：被匹配的路由的修饰符，表示被匹配的虚拟主机和 URL。该配置里有且只有一个必须配置的项 <code>operation</code>，例如 <code>details.default.svc.cluster.local:9080/*</code>。</li>
<li><strong>per_filter_config</strong>：这是一个 map 类型，<code>per_filter_config</code> 字段可用于为 filter 提供特定路由的配置。Map 的 key 应与 filleter 名称匹配，例如用于 HTTP buffer filter 的 <code>envoy.buffer</code>。该字段是特定于 filter 的，详情请参考 <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http_filters/http_filters#config-http-filters">HTTP filter</a>。</li>
</ul>

<p>关于 route.Route 的详细介绍请参考 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route/route.proto#envoy-api-msg-route-route">Envoy v2 API reference - route.Route</a>。</p>

<h3 id="cluster">Cluster</h3>

<p>Cluster 是指 Envoy 连接的一组逻辑相同的上游主机。Envoy 通过<a href="http://www.servicemesher.com/envoy/intro/arch_overview/service_discovery.html">服务发现</a>来发现 cluster 的成员。可以选择通过<a href="http://www.servicemesher.com/envoy/intro/arch_overview/health_checking.html#arch-overview-health-checking">主动健康检查</a>来确定集群成员的健康状态。Envoy 通过<a href="http://www.servicemesher.com/envoy/intro/arch_overview/load_balancing.html#arch-overview-load-balancing">负载均衡策略</a>决定将请求路由到 cluster 的哪个成员。</p>

<p><strong>Cluster 的特点</strong></p>

<ul>
<li>一组逻辑上相同的主机构成一个 cluster。</li>
<li>可以在 cluster 中定义各种负载均衡策略。</li>
<li>新加入的 cluster 需要一个热身的过程才可以给路由引用，该过程是原子的，即在 cluster 热身之前对于 Envoy 及 Service Mesh 的其余部分来说是不可见的。</li>
<li>可以通过多种方式来配置 cluster，例如静态类型、严格限定 DNS、逻辑 DNS、EDS 等。</li>
</ul>

<p><strong>Cluster 的数据结构</strong></p>

<p>Cluster 的数据结构如下，除了 <code>name</code> 字段，其他都是可选的。</p>

<pre><code class="language-json">{
  &quot;name&quot;: &quot;...&quot;,
  &quot;alt_stat_name&quot;: &quot;...&quot;,
  &quot;type&quot;: &quot;...&quot;,
  &quot;eds_cluster_config&quot;: &quot;{...}&quot;,
  &quot;connect_timeout&quot;: &quot;{...}&quot;,
  &quot;per_connection_buffer_limit_bytes&quot;: &quot;{...}&quot;,
  &quot;lb_policy&quot;: &quot;...&quot;,
  &quot;hosts&quot;: [],
  &quot;load_assignment&quot;: &quot;{...}&quot;,
  &quot;health_checks&quot;: [],
  &quot;max_requests_per_connection&quot;: &quot;{...}&quot;,
  &quot;circuit_breakers&quot;: &quot;{...}&quot;,
  &quot;tls_context&quot;: &quot;{...}&quot;,
  &quot;common_http_protocol_options&quot;: &quot;{...}&quot;,
  &quot;http_protocol_options&quot;: &quot;{...}&quot;,
  &quot;http2_protocol_options&quot;: &quot;{...}&quot;,
  &quot;extension_protocol_options&quot;: &quot;{...}&quot;,
  &quot;dns_refresh_rate&quot;: &quot;{...}&quot;,
  &quot;dns_lookup_family&quot;: &quot;...&quot;,
  &quot;dns_resolvers&quot;: [],
  &quot;outlier_detection&quot;: &quot;{...}&quot;,
  &quot;cleanup_interval&quot;: &quot;{...}&quot;,
  &quot;upstream_bind_config&quot;: &quot;{...}&quot;,
  &quot;lb_subset_config&quot;: &quot;{...}&quot;,
  &quot;ring_hash_lb_config&quot;: &quot;{...}&quot;,
  &quot;original_dst_lb_config&quot;: &quot;{...}&quot;,
  &quot;least_request_lb_config&quot;: &quot;{...}&quot;,
  &quot;common_lb_config&quot;: &quot;{...}&quot;,
  &quot;transport_socket&quot;: &quot;{...}&quot;,
  &quot;metadata&quot;: &quot;{...}&quot;,
  &quot;protocol_selection&quot;: &quot;...&quot;,
  &quot;upstream_connection_options&quot;: &quot;{...}&quot;,
  &quot;close_connections_on_host_health_failure&quot;: &quot;...&quot;,
  &quot;drain_connections_on_host_removal&quot;: &quot;...&quot;
}
</code></pre>

<p>下面是关于上述数据结构中的常用配置解析。</p>

<ul>
<li><strong>name</strong>：如果你留意到作为 Sidecar 启动的 Envoy 的参数的会注意到 <code>--max-obj-name-len 189</code>，该选项用来用来指定 cluster 的名字，例如 <code>inbound|9080||ratings.default.svc.cluster.local</code>。该名字字符串由 <code>|</code> 分隔成四个部分，分别是 <code>inbound</code> 或 <code>outbound</code> 代表入向流量或出向流量、端口号、subcluster 名称、FQDN，其中 subcluster 名称将对应于 Istio <code>DestinationRule</code> 中配置的 <code>subnet</code>，如果是按照多版本按比例路由的话，该值可以是版本号。</li>
<li><strong>type</strong>：即<a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/service_discovery#arch-overview-service-discovery-types">服务发现类型</a>，支持的参数有 <code>STATIC</code>（缺省值）、<code>STRICT_DNS</code>、<code>LOGICAL_DNS</code>、<code>EDS</code>、<code>ORIGINAL_DST</code>。</li>
<li><strong>hosts</strong>：这是个列表，配置负载均衡的 IP 地址和端口，只有使用了  <code>STATIC</code>、<code>STRICT_DNS</code>、<code>LOGICAL_DNS</code> 服务发现类型时才需要配置。</li>
<li><strong>eds_cluster_config</strong>：如果使用 <code>EDS</code> 做服务发现，则需要配置该项目，其中包括的配置有 <code>service_name</code> 和 <code>ads</code>。</li>
</ul>

<p>关于 Cluster 的详细介绍请参考 <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/cds.proto#cluster">Envoy v2 API reference - cluster</a>。</p>

<h2 id="参考">参考</h2>

<ul>
<li><a href="http://www.servicemesher.com/envoy/configuration/overview/v2_overview.html">Envoy v2 API 概览 - servicemesher.com</a></li>
<li><a href="http://www.servicemesher.com/envoy/configuration/listeners/lds.html">监听器发现服务（LDS）- servicemesher.com</a></li>
<li><a href="http://www.servicemesher.com/envoy/configuration/http_conn_man/rds.html">路由发现服务（RDS）- servicemesher.com</a></li>
<li><a href="http://www.servicemesher.com/envoy/configuration/cluster_manager/cds.html">集群发现服务（CDS）- servicemesher.com</a></li>
<li><a href="https://jimmysong.io/istio-handbook/concepts/envoy-xds-protocol.html">xDS 协议解析 - jimmysong.io</a></li>
<li><a href="https://www.cnblogs.com/163yun/p/8962278.html">深入解读 Service Mesh 背后的技术细节 - cnblogs.com</a><a href="https://jimmysong.io/posts/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/">理解 Istio Service Mesh 中 Envoy 代理 Sidecar 注入及流量劫持 - jimmysong.io</a></li>
</ul>

                
                    
                        <div class="entry-shang text-center">
	<p>「真诚赞赏，手留余香」</p>
	<button class="zs show-zs btn btn-bred">赞赏</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
	<div class="zs-modal-head">
		<button type="button" class="close">×</button>
		<span class="author"><img src="/img/avatar-icon.png"/>Jimmy Song</span>
		<p class="tip"><i></i><span>真诚赞赏，手留余香</span></p>

	</div>
	<div class="zs-modal-body">
		<div class="zs-modal-btns">
			<button class="btn btn-blink" data-num="2">2元</button>
			<button class="btn btn-blink" data-num="5">5元</button>
			<button class="btn btn-blink" data-num="10">10元</button>
			<button class="btn btn-blink" data-num="50">50元</button>
			<button class="btn btn-blink" data-num="100">100元</button>
			<button class="btn btn-blink" data-num="1">任意金额</button>
		</div>
		<div class="zs-modal-pay">
			<button class="btn btn-bred" id="pay-text">2元</button>
			<p>使用<span id="pay-type">微信</span>扫描二维码完成支付</p>
			<img src="/img/alipay-2.png" id="pay-image"/>
		</div>
	</div>
	<div class="zs-modal-footer">
		<label><input type="radio" name="zs-type" value="alipay" class="zs-type" checked="checked"><span class="zs-alipay"><img src="/img/alipay-btn.png"/></span></label>
		<label><input type="radio" name="zs-type" value="wechat" class="zs-type"><span class="zs-wechat"><img src="/img/wechat-btn.png"/></span></label>
	</div>
</div>

                    
                
            </article>

            <ul class="pager blog-pager">
                
                <li class="previous">
                    <a href="https://jimmysong.io/posts/supergloo-a-service-mesh-orchestrator/" data-toggle="tooltip" data-placement="top" title="SuperGloo—服务网格编排平台">&larr; 前一篇</a>
                </li>
                 
                <li class="next">
                    <a href="https://jimmysong.io/posts/service-mesh-in-action-by-yangzhangxian-review/" data-toggle="tooltip" data-placement="top" title="《Service Mesh 实战—基于 Linkerd 和 Kubernetes 的微服务实践》读后感">后一篇 &rarr;</a>
                </li>
                
            </ul>
            
            <div>
                 
                <h2>相关推荐</h2>
                <ul>
                    
                    <li><a href="/posts/envoy-archiecture-and-terminology/">Envoy 的架构与基本术语</a></li>
                    
                    <li><a href="/posts/envoy-sidecar-routing-of-istio-service-mesh-deep-dive/">理解 Istio Service Mesh 中 Envoy Sidecar 代理的路由转发</a></li>
                    
                    <li><a href="/posts/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/">理解 Istio Service Mesh 中 Envoy 代理 Sidecar 注入及流量劫持</a></li>
                    
                    <li><a href="/posts/envoyproxy-docs-cn-1.7-release/">Envoy最新官方文档中文版发布——由ServiceMesher社区倾情奉献</a></li>
                    
                    <li><a href="/posts/servicemesher-community/">Envoy 最新官方文档翻译工作启动 - ServiceMesher 组织倾力打造</a></li>
                    
                </ul>
                
            </div>
            
            
            
            
<div>
    <h5 id="wc">5200 字 | 阅读需要 11 分钟</h5>
    <h5 id="tags">标签: 
        
        <a href="https://jimmysong.io/tags/envoy/">envoy</a>&nbsp;
        
        
        
        <a href="https://jimmysong.io/tags/xds/">xds</a>&nbsp;
        
        
    </h5>
</div>

            
            </div>
            
            
        </div>
    </div>
    </section>
</div>

    
        
            <hr style="filter: alpha(opacity=100,finishopacity=0,style=3)" width="80%" color=#987cb9 size=3>
            
<div class="container">

<a href="https://www.lfasiallc.com/events/kubecon-cloudnativecon-china-2019/co-located-events/" title="SOFAStack Cloud Native Workshop hosted by Ant Financial">
    <img src="https://gw.alipayobjects.com/mdn/site_comm/afts/img/A*fKBoRarK3vQAAAAAAAAAAABjARQnAQ" alt="SOFAStack Cloud Native Workshop 蚂蚁金服主办">
</a>
<hr>

</div>


        
    
    <footer id="footer">
    <div class="container">
        
        <div class="col-md-4 col-sm-6">
            <h4>关于本站</h4>

            关注Kubernetes/Service Mesh/Serverless/Cloud Native/Open Source，关注微信公众号获取最新资讯。<img src="/img/servicemesher-wechat-public-account-tiny.jpg" alt="ServiceMesher公众号二维码" />

            <hr class="hidden-md hidden-lg hidden-sm">

        </div>
        
        

        <div class="col-md-4 col-sm-6">

            
            <h4>最新博客</h4>

            <div class="blog-entries">
                
                <div class="item same-height-row clearfix">
                    <div class="name same-height-always">
                        <u><h5><a href="/posts/">Posts</a></h5></u>
                    </div>
                </div>
                
                <div class="item same-height-row clearfix">
                    <div class="name same-height-always">
                        <u><h5><a href="/posts/cloud-native-devops-book/">TheNewStack 云原生 Devops 报告解读</a></h5></u>
                    </div>
                </div>
                
                <div class="item same-height-row clearfix">
                    <div class="name same-height-always">
                        <u><h5><a href="/posts/open-source-cla/">开源社区贡献者协议介绍</a></h5></u>
                    </div>
                </div>
                
            </div>

            <hr class="hidden-md hidden-lg">
            

        </div>
        

        
        <div class="col-md-4 col-sm-6">

          <h4>联系我</h4>

            请扫描下面的微信二维码联系我加入微信交流群，获取KubeCon China 2019门票折扣优惠，详见<u><a href="/about">关于</a></u>页面。<img src="/img/jimmy-song-wechat-tiny.jpg" alt="Jimmy Song的微信" />

            <hr class="hidden-md hidden-lg hidden-sm">

        </div>
        
        

    </div>
    







<div id="copyright">
<div class="container">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://www.facebook.com/jimmysongio" title="Facebook">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/rootsongjc" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/jimmysongio" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/jimmysongio" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="http://weibo.com/jimmysongio" title="weibo">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="https://jimmysong.io/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
        &copy;2017-2019
          
            
              <a href="https://jimmysong.io/about">Jimmy Song(宋净超)</a>
            
          
          &nbsp;&bull;&nbsp;
          June 5,2019
          updated
          </br>
          
            <a href="https://jimmysong.io/">jimmysong.io</a>
          
          &nbsp;&bull;&nbsp;
          <a href="http://www.servicemesher.com">servicemesher.com</a>
          &nbsp;&bull;&nbsp;
          <a href="https://www.sofastack.tech">sofastack.tech</a>
        </p>
        
        <p class="credits theme-by text-muted">
        由 <a href="http://gohugo.io">Hugo v0.55.5</a> 强力驱动 &nbsp;&bull;&nbsp; 主题 <a href="https://github.com/rootsongjc/beautifulhugo">Beautiful Hugo</a> 移植自 <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
        
        </p>
      </div>
    </div>
  </div>
</footer>






<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/bootstrap.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/photoswipe-ui-default.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/photoswipe.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/auto-render.min.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/main.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/prism.js"></script>
<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/katex.min.js"></script>

<script src="https://jimmysong.io/js/reward.js"></script>



<script src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/baguetteBox.js"></script>
<script> baguetteBox.run('.gallery');</script>

<script> renderMathInElement(document.body); </script>


<script async defer src="https://buttons.github.io/buttons.js"></script>


  </body>
</html>

